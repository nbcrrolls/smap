<?xml version="1.0" standalone="no"?>

<kickstart>

        <description>
	SMAP
        Frontend stuffs. Set the share for opal
        </description>

        <copyright>
        Copyright (c) 2000 - 2008 The Regents of the University of California.
        All rights reserved.
        </copyright>

        <changelog>
        </changelog>


<post os="linux">



<!-- Make NFS shared directory for opal jobs -->
mkdir -m0755 -p /export/opal/smap/PDB
chown -R tomcat:tomcat /export/opal/smap


<file name="/etc/cron.daily/smap-job-cleanup" perms="0755">
#!/bin/bash

# Removes old opal job directories older then default days

# default number of days to keep job direcotry 
n=21

if [ -d /export/opal/opal-jobs ]; then
  cd /share/opal/smap/PDB
  dirs=`find . -type f -mtime +$n -print`
  for i in $dirs
  do
      rm -rf $i
  done
fi


</file>


<!-- update www docs with correct hostname --> 
sed -i "s/yourservername/&Kickstart_PublicHostname;/g" /var/www/html/roll-documentation/opal/`/opt/rocks/bin/rocks report version`/*.html 
 
<!-- add link to opal reference guide --> 
ln -s /opt/opal/docs /var/www/html/roll-documentation/opal/`/opt/rocks/bin/rocks report version`/refguide 

<!--    define a opal appliance    -->
/opt/rocks/bin/rocks add appliance opal-server membership="Opal Server" public=yes os=linux node=login
/opt/rocks/bin/rocks add appliance attr opal-server attr=opal_server value=true
#let's define the opal_public_fqdn attr for the first time
/opt/rocks/bin/rocks add attr attr=opal_public_fqdn value=&Kickstart_PublicHostname;

/opt/rocks/bin/rocks add host attr localhost  attr=opal_server value=true
/opt/rocks/bin/rocks set appliance attr opal-server submit_host true
/opt/rocks/bin/rocks set appliance attr opal-server exec_host false
/opt/rocks/bin/rocks set appliance attr opal-server sge true

</post>

</kickstart>
